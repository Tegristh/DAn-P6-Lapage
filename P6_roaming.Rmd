---
title: "librairie lapage - analyse des ventes"
author: "GIANNESINI Baptiste"
date: "16/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Sommaire
1. résumé de la mission
2. import des packages
3. import des données
4. variables et fonctions
5. nettoyage de données
6. analyse et réponses aux questions
  

## Résumé de la mission


## import des packages

```{r}
library(tidyverse)
library(ineq)
```

## import des données

```{r ,}
#import des données
clients = read.csv("customers.csv")
produits = read.csv("products.csv", sep=",", dec=".")
transactions = read.csv("transactions.csv", sep=",", dec=".")

```

## Variables et fonctions

```{r}
# jointure produit et transaction:
trans_produit = merge(produits, transactions, on="id_prod")

# jointure produit/transaction avec clients:
data = merge(trans_produit,clients, on="client_id")

# age des clients:
data$age <- 2021-data$birth


data$price = ifelse(test = data$price < 0, 0, data$price)

```

## mise en forme des données

```{r}
# transformation des dates en format date
data$date = as.Date(data$date)
data$year = as.numeric(format(data$date, format = "%Y"))
data$month = as.numeric(format(data$date, format = "%m"))
data$quarter = paste("Q",ceiling(as.numeric(data$month) / 3), sep="")
#data$day = as.numeric(format(data$date, format = "%d"))
data$quarter_date = paste(as.character(data$year),as.character(data$quarter), sep="-")
data$month_date = paste(as.character(data$year), as.character(data$month), sep="/")
```

#### Chiffre d'affaire par périodes:
##### CA Annuel
```{r}
# CA par année
data %>%
  group_by(year) %>%
  summarise(annual_CA = sum(price)) %>%
  ggplot(aes(x=year, y=annual_CA))+ geom_col()

```
##### CA Trimestriel
```{r}
# CA par trimestre
data %>%
  group_by(quarter_date) %>%
  summarise(quarter_CA = sum(price)) %>%
  ggplot(aes(x=quarter_date, y=quarter_CA))+ geom_col()
```
##### CA Mensuel
```{r}
# CA par mois

data %>%
  group_by(month_date) %>%
  summarise(month_CA = sum(price)) %>%
  ggplot(aes(x=month_date, y=month_CA))+ geom_col()+
  coord_flip()


```
#### Références:
##### Top:
```{r}
data %>%
  group_by(id_prod) %>%
  summarize(product_CA = sum(price)) %>%
  arrange(desc(by_group = product_CA))
```
##### Flop:
```{r}
data %>%
  group_by(id_prod) %>%
  summarize(product_CA = sum(price)) %>%
  arrange(by_group = product_CA)
```
##### Répartition du CA par catégorie:
```{r}
#colnames(chiffre_affaire_byCateg)=c("group","value")
#df = chiffre_affaire_byCateg 
#bp<- ggplot(df, aes(x="", y=value, fill=group))+
#geom_bar(width = 1, stat = "identity")

#pie <- bp + coord_polar("y", start=0)
#pie

# à revoir pour le label
data %>%
  group_by(categ) %>%
  mutate(categ=as.character(categ)) %>%
  summarize(categ_CA = sum(price),pourcent = (sum(price)/11853729*100)) %>%
  ggplot(aes(x = "", y = categ_CA, fill = categ)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) #+
  #geom_text(aes(y = , label = pourcent), color = "white")
```
##### Répartition du Chiffre d'affaire par client:
```{r}
# Chiffre d'affaire par client
#chiffre_affaire_byClient = aggregate(x=data$price, by= list(data$client_id), FUN=sum)
#colnames(chiffre_affaire_byClient) = c("client", "CA")
#visualisation graphique:
#ggplot(chiffre_affaire_byClient,aes(x=client,y=CA))+geom_point()

data %>%
  group_by(client_id) %>%
  summarise(client_CA = sum(price)) %>%
  ggplot(aes(x=client_id, y=client_CA))+
  geom_point()
```
```{r}
data %>%
  group_by(client_id) %>%
  summarise(client_CA = sum(price)) %>%
  filter(client_CA < 100000) %>%
  ggplot(aes(x=client_id, y=client_CA))+
  geom_point()
```
##### Courbe de lorenz
```{r}
# Chiffre d'affaire par client
#chiffre_affaire_byClient = aggregate(x=data$price, by= list(data$client_id), FUN=sum)
#colnames(chiffre_affaire_byClient) = c("client", "CA")
#plot(Lc(chiffre_affaire_byClient$CA))

chiffre_affaire_byClient =data %>%
  group_by(client_id) %>%
  summarize(Client_CA = sum(price))

plot(Lc(chiffre_affaire_byClient$Client_CA))

```
```{r}
# calcul du coefficient de Gini
# https://fr.wikipedia.org/wiki/Coefficient_de_Gini
ineq(chiffre_affaire_byClient$Client_CA, type="Gini")
```

### lien entre age des clients et montant total des achats, fréquence d'achats, taille du panier moyen et catégories de livres achetés

```{R}
# CA par Genre du client et catégorie de produit acheté

data %>%
  group_by(sex, categ) %>%
  summarise(CA_by_genre = sum(price)) %>%
  ggplot(aes(x=categ, y=CA_by_genre, fill=sex))+ geom_bar(stat="identity", position=position_dodge())


```

```{r}
#a revoir

data %>%
  group_by(sex, categ) %>%
  summarise(CA_by_genre = sum(price)) #%>%
  
  #chisq.test(CA_by_genre)
 

#category_by_genre$sex <- ifelse(category_by_genre$sex == "m", 1, 0)
#tableau = select(category_by_genre, sex, categ, category_by_genre )
#chisq.test(CA_by_genre)

```

```{r}




```








```{r}
summary(data$age_client)
table(data$age_client)
#règle de sturge
N = 92-17
K = 1+(10/3*log10(N))
K
```
```{r}
data = data %>%
  mutate( 
    # Create catégories
    age_group = dplyr::case_when( 
      data$age <= 24 ~"0-24",
      data$age > 24 & age <= 31 ~"25-31",
      data$age > 31 & age <= 38 ~"32-38",
      data$age > 38 & age <= 45 ~"39-45",
      data$age > 45 & age <= 52 ~"46-52",
      data$age > 52 & age <= 59 ~"53-59",
      data$age > 59 & age <= 66 ~"60-66",
      data$age > 66 & age <= 73 ~"67-73",
      data$age > 73 & age <= 80 ~"74-80",
      data$age > 80 & age <= 87 ~"81-87",
      data$age >=88  ~">87",
      )
    ,
    # Convert to factor
    age_group = factor( 
      age_group,
      levels = c("0-24", "25-31", "32-38", "39-45", "46-52", "53-59", "60-66", "67-73", "74-80", "81-87", ">87" )
      ))
    
```


### 
```{r}
# CA par age du client et catégorie de produit acheté
data %>%
  group_by(age_group, categ) %>%
  summarize(CA_by_age = sum(price)) %>%
  mutate(category=as.character(categ)) %>%
  ggplot(aes(x=age_group, y=CA_by_age, fill=category)) + 
  geom_bar(stat="identity")
  

 
```

### Age des clients et montant total des achats
```{r}
data %>%
  group_by(age) %>%
  summarise(total_buy_by_age = sum(price)) %>%
  ggplot(aes(x=total_buy_by_age, y=age))+ geom_point()+
  coord_flip()
```



### Age des clients et panier moyen
```{r}
data %>%
  group_by(session_id, age_group) %>%
  summarize(session_somme= sum(price)) %>%
  group_by(age_group) %>%
  summarise(panier_moyen = mean(session_somme)) %>%
  ggplot(aes(x=panier_moyen, y=age_group)) +
  geom_point(stat="identity")+
  coord_flip()
```

```{r}
data %>%
  group_by(session_id, age) %>%
  summarize(session_somme= sum(price)) %>%
  group_by(age) %>%
  summarise(panier_moyen = mean(session_somme)) %>%
  ggplot(aes(x=panier_moyen, y=age)) +
  geom_point(stat="identity")+
  coord_flip()
```

### Age des clients et fréquence d'Achat
```{r}
# a REVOIR
# nb commande et nb client / age



#frequence_by_client = data %>%
#  group_by(client_id) %>%
#  summarize(frequence_by_client = n_distinct(session_id),
#            age = max(age))
#frequence_by_client

#frequence_by_age = frequence_by_client %>%
#  group_by(age_group) %>%
#  summarise(frequence_by_age= mean(frequence_by_client))
#frequence_by_age
#ggplot(frequence_by_age, aes(x=frequence_by_age, y=age_group))+ geom_col()
```

```{r}
data %>%
  summarize(nb_session=n_distinct(session_id))
  
data %>%
  group_by(client_id) %>%
  summarize(frequence_by_client = n_distinct(session_id),
            age = max(age)) %>%
  group_by(age)%>%
  summarize(moy = mean(frequence_by_client))%>%
  ggplot(aes(x=moy, y=age)) +
  geom_point(stat="identity")
# a faire en boxplot

```
```{r}
data %>%
  group_by(client_id) %>%
  summarize(frequence_by_client = n_distinct(session_id), age_group) %>%
  group_by(age_group) %>%
  summarize(moyen = mean(frequence_by_client)) %>%
  ggplot(aes(x=moyen, y=age_group)) +
  geom_point(stat="identity")+
  coord_flip()
```
```{r}
data %>%
  group_by(client_id) %>%
  summarize(frequence_by_client = n_distinct(session_id), age_group) %>%
  filter(frequence_by_client<1500) %>%
  #group_by(age_group) %>%
  #summarize(moyen = mean(frequence_by_client)) %>%
  ggplot(aes(x=frequence_by_client, y=age_group)) +
  geom_boxplot()+
  coord_flip()
```


```{r}
# nombre de clients par tranche d'age
custom_count_by_age = data %>%
  group_by(age_group) %>%
  summarise(custom_count_by_age = n_distinct(client_id))
custom_count_by_age
ggplot(custom_count_by_age, aes(x=custom_count_by_age, y=age_group))+ geom_col()
```
#### Calcul de proba
```{r}
# calcul du nombre de clients qui ont acheté 2_159
# récupérer la liste des transactions concernant 2_159
#liste2_159 = subset(data, id_prod == "2_159")
#liste2_159
# récupération de la liste des clients
#liste2_159 = liste2_159[,1]
#population = length(liste2_159)

#récupération de la liste des transactions concernant 0_525 et les clients qui ont acheté 2_159
#sous_pop = subset(data, client_id=liste2_159 & id_prod == "0_525")
#sous_pop
#echantillon = length(sous_pop[,1])

#probabilite = echantillon/population
#probabilite

data %>%
  summarize(client_total = n_distinct(client_id))
data %>%
  filter(id_prod == "2_159") %>%
  summarize(clients_ref2 = n_distinct(client_id))
data %>%
  filter(id_prod == "0_525") %>%
  summarize(clients_ref0 = n_distinct(client_id))
```

```{r}
a = (530/8602)*100
b = (459/8602)*100
a
b
b/a*100
```

```{r}
data %>%
  filter(price > 0)
```